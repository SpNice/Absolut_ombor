<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absolut ERP | Professional Ombor</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --secondary: #3f37c9; --success: #2ec4b6; --danger: #e71d36; --warning: #ff9f1c; --bg: #f8f9fd; --sidebar: #ffffff; --text: #2b2d42; --gray: #8d99ae; --radius: 12px; --shadow: 0 4px 20px rgba(0,0,0,0.05); }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #edf2f7; display: flex; flex-direction: column; padding: 20px; }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; border-radius: var(--radius); color: var(--gray); text-decoration: none; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; }
        .nav-link:hover { background: #f0f3ff; color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; }
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 12px; color: var(--gray); border-bottom: 1px solid #eee; font-size: 13px; }
        td { padding: 12px; border-bottom: 1px solid #f9f9f9; font-size: 14px; }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        button { padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        input, select { padding: 10px; border: 1px solid #ddd; border-radius: 8px; width: 100%; margin-bottom: 10px; }
        .hidden { display: none !important; }
        #loginPage { position: fixed; inset: 0; background: var(--primary); display: flex; align-items: center; justify-content: center; z-index: 10000; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="card" style="width: 350px; text-align: center;">
        <h2 style="color: var(--primary);">Absolut ERP</h2>
        <input id="loginInp" placeholder="Login">
        <input id="passInp" type="password" placeholder="Parol">
        <button class="btn-main" style="width: 100%;" onclick="login()">Kirish</button>
    </div>
</div>

<div id="sidebar" class="sidebar hidden">
    <div class="logo"><i class="fas fa-cubes"></i> Absolut</div>
    <div class="nav-link active" onclick="showPage('dash', this)"><i class="fas fa-home"></i> Dashboard</div>
    <div class="nav-link" onclick="showPage('ombor', this)"><i class="fas fa-box"></i> Ombor</div>
    <div id="navTabel" class="nav-link" onclick="showPage('tabel', this)"><i class="fas fa-calendar-check"></i> Tabel</div>
    <div class="nav-link" onclick="showPage('history', this)"><i class="fas fa-history"></i> Operatsiyalar</div>
    <div class="nav-link" onclick="showPage('reports', this)"><i class="fas fa-chart-bar"></i> Hisobotlar</div>
    <div class="nav-link" onclick="showPage('settings', this)"><i class="fas fa-user-shield"></i> Admin Panel</div>
    <button class="btn-main" onclick="location.reload()" style="margin-top: auto; background: var(--danger);">Chiqish</button>
</div>

<div id="main" class="main-content hidden">
    <div id="dashPage">
        <h3>Xush kelibsiz, <span id="uName"></span>!</h3>
        <div style="display: flex; gap: 20px;">
            <div class="card" style="flex:1"><h4>Mahsulotlar</h4><h2 id="st1">0</h2></div>
            <div class="card" style="flex:1"><h4>Kam qolgan</h4><h2 id="st2" style="color:orange">0</h2></div>
        </div>
    </div>

    <div id="omborPage" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content: space-between; margin-bottom: 15px;">
                <h3>Ombor qoldig'i</h3>
                <button class="btn-main" onclick="addProduct()">+ Mahsulot</button>
            </div>
            <div id="invTable"></div>
        </div>
    </div>

    <div id="tabelPage" class="hidden">
        <div class="card">
            <h3>Davomat (Tabel)</h3>
            <p id="todayDate"></p>
            <div id="tabelList"></div>
        </div>
    </div>

    <div id="historyPage" class="hidden">
        <div class="card">
            <h3>Ombor operatsiyalari tarixi</h3>
            <div id="histTable"></div>
        </div>
    </div>

    <div id="reportsPage" class="hidden">
        <div class="card">
            <h3>Oylik davomat hisoboti</h3>
            <div id="attReportTable"></div>
        </div>
        <button class="btn-main" onclick="exportToExcel()">Excelga yuklash</button>
    </div>

    <div id="settingsPage" class="hidden">
        <div class="card" id="adminOnly">
            <h3>Foydalanuvchilar va Huquqlar</h3>
            <button class="btn-main" onclick="addUser()">+ Yangi foydalanuvchi</button>
            <div id="userTable"></div>
        </div>
    </div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("abs_erp_v4")) || {
    products: [],
    transactions: [],
    employees: [],
    attendance: [], // {date, empId, status: 'p'/'a'}
    users: [{id: 1, login: "admin", pass: "admin", role: "admin", name: "Admin", canTabel: true}]
};

let user = null;

function save() { localStorage.setItem("abs_erp_v4", JSON.stringify(data)); render(); }

function login() {
    let l = document.getElementById("loginInp").value;
    let p = document.getElementById("passInp").value;
    user = data.users.find(u => u.login === l && u.pass === p);
    if(!user) return alert("Xato!");
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("sidebar").classList.remove("hidden");
    document.getElementById("main").classList.remove("hidden");
    document.getElementById("uName").innerText = user.name;
    
    // Check Tabel Permission
    if(!user.canTabel && user.role !== 'admin') document.getElementById("navTabel").classList.add("hidden");
    if(user.role !== 'admin') document.getElementById("adminOnly").classList.add("hidden");
    
    render();
}

function showPage(p, el) {
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    ['dash','ombor','tabel','history','reports','settings'].forEach(id => document.getElementById(id+'Page').classList.add('hidden'));
    document.getElementById(p+'Page').classList.remove('hidden');
    render();
}

function render() {
    // Stats
    document.getElementById("st1").innerText = data.products.length;
    document.getElementById("st2").innerText = data.products.filter(p => p.qty < 5).length;

    // Inventory
    let invH = `<table><tr><th>Nomi</th><th>Miqdor</th><th>Amal</th></tr>`;
    data.products.forEach(p => {
        invH += `<tr><td>${p.name}</td><td><b>${p.qty} ${p.unit}</b></td>
        <td><button onclick="op(${p.id},'in')">+</button> <button onclick="op(${p.id},'out')">-</button></td></tr>`;
    });
    document.getElementById("invTable").innerHTML = invH + `</table>`;

    // History (Filter for Skladovshik)
    let histH = `<table><tr><th>Vaqt</th><th>Mahsulot</th><th>Amal</th><th>Kim</th></tr>`;
    let filteredHist = user.role === 'admin' ? data.transactions : data.transactions.filter(t => t.userId === user.id);
    filteredHist.slice().reverse().forEach(t => {
        histH += `<tr><td><small>${t.date.split('T')[0]}</small></td><td>${t.pName}</td>
        <td style="color:${t.type==='in'?'green':'red'}">${t.type==='in'?'Kirim':'Chiqim'} (${t.qty})</td><td>${t.uName}</td></tr>`;
    });
    document.getElementById("histTable").innerHTML = histH + `</table>`;

    // Tabel
    document.getElementById("todayDate").innerText = new Date().toLocaleDateString();
    let tabH = `<table><tr><th>Xodim</th><th>Holat</th></tr>`;
    data.employees.forEach(e => {
        let att = data.attendance.find(a => a.empId === e.id && a.date === new Date().toISOString().split('T')[0]);
        tabH += `<tr><td>${e.name}</td><td>
            <button class="${att?.status==='p'?'btn-main':''}" onclick="mark(${e.id},'p')">Keldi</button>
            <button style="background:red; color:white;" class="${att?.status==='a'?'btn-main':''}" onclick="mark(${e.id},'a')">Kelmad</button>
        </td></tr>`;
    });
    document.getElementById("tabelList").innerHTML = tabH + `</table>`;

    // Attendance Report
    let repH = `<table><tr><th>Xodim</th><th>Keldi (Kun)</th><th>Kelmagan</th></tr>`;
    data.employees.forEach(e => {
        let pCount = data.attendance.filter(a => a.empId === e.id && a.status === 'p').length;
        let aCount = data.attendance.filter(a => a.empId === e.id && a.status === 'a').length;
        repH += `<tr><td>${e.name}</td><td><b style="color:green">${pCount}</b></td><td><b style="color:red">${aCount}</b></td></tr>`;
    });
    document.getElementById("attReportTable").innerHTML = repH + `</table>`;

    // Users (Admin Only)
    if(user.role === 'admin') {
        let usH = `<table><tr><th>Login</th><th>F.I.SH</th><th>Tabelga ruxsat</th></tr>`;
        data.users.forEach(u => {
            usH += `<tr><td>${u.login}</td><td>${u.name}</td>
            <td><input type="checkbox" ${u.canTabel?'checked':''} onchange="toggleTabel(${u.id})"></td></tr>`;
        });
        document.getElementById("userTable").innerHTML = usH + `</table>`;
    }
}

function op(id, type) {
    let p = data.products.find(x => x.id === id);
    let q = parseFloat(prompt("Miqdor:"));
    if(!q) return;
    if(type==='in') p.qty += q; else p.qty -= q;
    data.transactions.push({id: Date.now(), userId: user.id, uName: user.name, pName: p.name, type, qty: q, date: new Date().toISOString()});
    save();
}

function mark(empId, status) {
    let today = new Date().toISOString().split('T')[0];
    data.attendance = data.attendance.filter(a => !(a.empId === empId && a.date === today));
    data.attendance.push({date: today, empId, status});
    save();
}

function addProduct() {
    let n = prompt("Nomi:"); if(n) data.products.push({id: Date.now(), name: n, qty: 0, unit: 'dona'});
    save();
}

function addUser() {
    let l = prompt("Login:");
    let p = prompt("Parol:");
    let n = prompt("Ism:");
    if(l && p) data.users.push({id: Date.now(), login: l, pass: p, name: n, role: 'sklad', canTabel: false});
    save();
}

function toggleTabel(id) {
    let u = data.users.find(x => x.id === id);
    u.canTabel = !u.canTabel;
    save();
}

// Pre-fill some employees if empty
if(data.employees.length === 0) {
    data.employees = [{id:101, name: "Xodim 1"}, {id:102, name: "Xodim 2"}];
    save();
}
</script>
</body>
</html>
