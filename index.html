<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Absolut ERP Pro v6 | Full Management</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root { --primary: #4361ee; --secondary: #3f37c9; --success: #2ec4b6; --danger: #e71d36; --warning: #ff9f1c; --bg: #f4f7fe; --sidebar: #ffffff; --text: #2b2d42; --gray: #8d99ae; --radius: 12px; }
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 260px; background: var(--sidebar); border-right: 1px solid #e0e4ec; display: flex; flex-direction: column; padding: 20px; z-index: 100; }
        .logo { font-size: 22px; font-weight: 800; color: var(--primary); margin-bottom: 30px; display: flex; align-items: center; gap: 10px; }
        .nav-link { padding: 12px 15px; border-radius: var(--radius); color: var(--gray); text-decoration: none; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; cursor: pointer; transition: 0.2s; font-weight: 500; }
        .nav-link:hover { background: #f0f3ff; color: var(--primary); }
        .nav-link.active { background: var(--primary); color: white; }
        
        /* Main */
        .main-content { flex: 1; overflow-y: auto; padding: 25px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
        .card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid #f0f0f0; }
        
        /* Tables */
        table { width: 100%; border-collapse: collapse; background: white; }
        th { text-align: left; padding: 14px; color: var(--gray); border-bottom: 2px solid #f4f7fe; font-size: 13px; text-transform: uppercase; }
        td { padding: 14px; border-bottom: 1px solid #f4f7fe; font-size: 14px; }
        tr:hover { background: #fcfdfe; }
        
        /* UI Elements */
        input, select { padding: 11px; border: 1px solid #e0e4ec; border-radius: 8px; width: 100%; margin-bottom: 12px; outline: none; }
        button { padding: 8px 14px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-edit { background: #eef2ff; color: var(--primary); }
        .btn-danger { background: #fff5f5; color: var(--danger); }
        .badge { padding: 4px 8px; border-radius: 6px; font-size: 11px; }

        .hidden { display: none !important; }
        #loginPage { position: fixed; inset: 0; background: #f4f7fe; display: flex; align-items: center; justify-content: center; z-index: 10000; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    </style>
</head>
<body>

<div id="loginPage">
    <div class="card" style="width: 350px; text-align: center;">
        <h2 style="color:var(--primary)">Absolut ERP</h2>
        <input id="loginInp" placeholder="Login">
        <input id="passInp" type="password" placeholder="Parol">
        <button class="btn-main" style="width: 100%;" onclick="login()">Kirish</button>
    </div>
</div>

<div id="sidebar" class="sidebar hidden">
    <div class="logo"><i class="fas fa-warehouse"></i> Absolut</div>
    <div class="nav-link active" onclick="showPage('ombor', this)"><i class="fas fa-boxes"></i> Ombor</div>
    <div id="navTabel" class="nav-link" onclick="showPage('tabel', this)"><i class="fas fa-user-check"></i> Davomat</div>
    <div class="nav-link" onclick="showPage('history', this)"><i class="fas fa-history"></i> Tarix</div>
    <div class="nav-link" onclick="showPage('reports', this)"><i class="fas fa-chart-pie"></i> Hisobotlar</div>
    <div class="nav-link" onclick="showPage('admin', this)"><i class="fas fa-cog"></i> Sozlamalar</div>
    <button class="btn-danger" style="margin-top:auto" onclick="location.reload()">Chiqish</button>
</div>

<div id="main" class="main-content hidden">
    
    <div id="omborPage">
        <div class="header"><h2>Mahsulotlar</h2> <button class="btn-main" onclick="openProdModal()">+ Yangi Mahsulot</button></div>
        <div class="card"><div id="invTable"></div></div>
    </div>

    <div id="tabelPage" class="hidden">
        <div class="header"><h2>Davomat (Tabel)</h2></div>
        <div class="card"><div id="tabelList"></div></div>
    </div>

    <div id="historyPage" class="hidden">
        <div class="header"><h2>Operatsiyalar Tarixi</h2></div>
        <div class="card"><div id="histTable"></div></div>
    </div>

    <div id="reportsPage" class="hidden">
        <div class="header"><h2>Hisobotlar</h2></div>
        <div class="card"><h3>Davomat statistikasi</h3><div id="attReportTable"></div></div>
        <button class="btn-main" onclick="exportToExcel()">Excelga yuklash</button>
    </div>

    <div id="adminPage" class="hidden">
        <div class="card">
            <h3>Tizim foydalanuvchilari</h3>
            <button class="btn-main" onclick="openUserModal()">+ Foydalanuvchi</button>
            <div id="userTable"></div>
        </div>
        <div class="card">
            <h3>Ishchi xodimlar</h3>
            <button class="btn-main" onclick="openEmpModal()">+ Xodim qo'shish</button>
            <div id="empTable"></div>
        </div>
    </div>
</div>

<div id="modal" class="modal hidden">
    <div class="card" id="modalContent" style="width: 400px;"></div>
</div>

<script>
let data = JSON.parse(localStorage.getItem("abs_erp_v6")) || {
    products: [],
    transactions: [],
    employees: [],
    attendance: [],
    users: [{id: 1, login: "admin", pass: "admin", role: "admin", name: "Asosiy Admin", canTabel: true}]
};

let user = null;
const save = () => { localStorage.setItem("abs_erp_v6", JSON.stringify(data)); render(); };

function login() {
    let l = document.getElementById("loginInp").value;
    let p = document.getElementById("passInp").value;
    user = data.users.find(u => u.login === l && u.pass === p);
    if(!user) return alert("Xato!");
    document.getElementById("loginPage").classList.add("hidden");
    document.getElementById("sidebar").classList.remove("hidden");
    document.getElementById("main").classList.remove("hidden");
    if(!user.canTabel && user.role !== 'admin') document.getElementById("navTabel").classList.add("hidden");
    render();
}

function showPage(p, el) {
    document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
    ['ombor','tabel','history','reports','admin'].forEach(id => document.getElementById(id+'Page').classList.add('hidden'));
    document.getElementById(p+'Page').classList.remove('hidden');
    render();
}

function render() {
    // Inventory
    let invH = `<table><tr><th>Nomi</th><th>Kategoriya</th><th>Qoldiq</th><th>Amal</th></tr>`;
    data.products.forEach(p => {
        invH += `<tr><td><b>${p.name}</b></td><td>${p.cat}</td><td>${p.qty} ${p.unit}</td><td>
            <button class="btn-main" onclick="op(${p.id},'in')">+</button>
            <button class="btn-main" onclick="op(${p.id},'out')">-</button>
            <button class="btn-edit" onclick="openProdModal(${p.id})"><i class="fas fa-edit"></i></button>
            <button class="btn-danger" onclick="deleteObj('products', ${p.id})"><i class="fas fa-trash"></i></button>
        </td></tr>`;
    });
    document.getElementById("invTable").innerHTML = invH + `</table>`;

    // History
    let histH = `<table><tr><th>Sana</th><th>Mahsulot</th><th>Amal</th><th>Xodim</th></tr>`;
    data.transactions.slice().reverse().slice(0,20).forEach(t => {
        histH += `<tr><td><small>${t.date.split('T')[0]}</small></td><td>${t.pName}</td><td>${t.type==='in'?'Kirim':'Chiqim'} (${t.qty})</td><td>${t.uName}</td></tr>`;
    });
    document.getElementById("histTable").innerHTML = histH + `</table>`;

    // Tabel
    let tabH = `<table><tr><th>Xodim</th><th>Lavozim</th><th>Holat</th></tr>`;
    data.employees.forEach(e => {
        let att = data.attendance.find(a => a.empId === e.id && a.date === new Date().toISOString().split('T')[0]);
        tabH += `<tr><td>${e.name}</td><td>${e.pos}</td><td>
            <button style="background:${att?.status==='p'?'#2ec4b6':'#eee'}" onclick="mark(${e.id},'p')">Keldi</button>
            <button style="background:${att?.status==='a'?'#e71d36':'#eee'}" onclick="mark(${e.id},'a')">Yo'q</button>
        </td></tr>`;
    });
    document.getElementById("tabelList").innerHTML = tabH + `</table>`;

    // Reports
    let repH = `<table><tr><th>Xodim</th><th>Keldi</th><th>Kelmadi</th></tr>`;
    data.employees.forEach(e => {
        repH += `<tr><td>${e.name}</td><td style="color:green">${data.attendance.filter(a=>a.empId===e.id && a.status==='p').length}</td><td style="color:red">${data.attendance.filter(a=>a.empId===e.id && a.status==='a').length}</td></tr>`;
    });
    document.getElementById("attReportTable").innerHTML = repH + `</table>`;

    // Admin: Users & Employees
    let userH = `<table><tr><th>Login</th><th>Foydalanuvchi</th><th>Amal</th></tr>`;
    data.users.forEach(u => {
        userH += `<tr><td>${u.login}</td><td>${u.name}</td><td>
            <button class="btn-edit" onclick="openUserModal(${u.id})"><i class="fas fa-edit"></i></button>
            <button class="btn-danger" onclick="deleteObj('users', ${u.id})">X</button>
        </td></tr>`;
    });
    document.getElementById("userTable").innerHTML = userH + `</table>`;

    let empH = `<table><tr><th>Ism</th><th>Lavozim</th><th>Amal</th></tr>`;
    data.employees.forEach(e => {
        empH += `<tr><td>${e.name}</td><td>${e.pos}</td><td>
            <button class="btn-edit" onclick="openEmpModal(${e.id})"><i class="fas fa-edit"></i></button>
            <button class="btn-danger" onclick="deleteObj('employees', ${e.id})">X</button>
        </td></tr>`;
    });
    document.getElementById("empTable").innerHTML = empH + `</table>`;
}

/* CRUD LOGIC */
function deleteObj(key, id) { if(confirm("O'chirilsinmi?")) { data[key] = data[key].filter(x => x.id !== id); save(); } }

// MODAL OPENERS
function openProdModal(id = null) {
    let p = id ? data.products.find(x=>x.id===id) : {name:'', cat:'', unit:'', price:0};
    document.getElementById("modalContent").innerHTML = `
        <h3>${id?'Tahrirlash':'Yangi Mahsulot'}</h3>
        <input id="m_name" value="${p.name}" placeholder="Nomi">
        <input id="m_cat" value="${p.cat}" placeholder="Kategoriya">
        <input id="m_unit" value="${p.unit}" placeholder="Birlik (dona, kg)">
        <input id="m_price" type="number" value="${p.price}" placeholder="Narxi">
        <button class="btn-main" onclick="saveProd(${id})">Saqlash</button>
        <button onclick="closeModal()">Yopish</button>
    `;
    document.getElementById("modal").classList.remove("hidden");
}

function openUserModal(id = null) {
    let u = id ? data.users.find(x=>x.id===id) : {login:'', pass:'', name:''};
    document.getElementById("modalContent").innerHTML = `
        <h3>Foydalanuvchi</h3>
        <input id="u_login" value="${u.login}" placeholder="Login">
        <input id="u_pass" value="${u.pass}" placeholder="Parol">
        <input id="u_name" value="${u.name}" placeholder="Ismi">
        <button class="btn-main" onclick="saveUser(${id})">Saqlash</button>
        <button onclick="closeModal()">Yopish</button>
    `;
    document.getElementById("modal").classList.remove("hidden");
}

function openEmpModal(id = null) {
    let e = id ? data.employees.find(x=>x.id===id) : {name:'', pos:''};
    document.getElementById("modalContent").innerHTML = `
        <h3>Xodim ma'lumotlari</h3>
        <input id="e_name" value="${e.name}" placeholder="F.I.SH">
        <input id="e_pos" value="${e.pos}" placeholder="Lavozimi">
        <button class="btn-main" onclick="saveEmp(${id})">Saqlash</button>
        <button onclick="closeModal()">Yopish</button>
    `;
    document.getElementById("modal").classList.remove("hidden");
}

// SAVERS
function saveProd(id) {
    let obj = {id: id || Date.now(), name: document.getElementById("m_name").value, cat: document.getElementById("m_cat").value, unit: document.getElementById("m_unit").value, price: document.getElementById("m_price").value, qty: id ? data.products.find(x=>x.id===id).qty : 0};
    if(id) data.products = data.products.map(x=>x.id===id?obj:x); else data.products.push(obj);
    save(); closeModal();
}

function saveUser(id) {
    let obj = {id: id || Date.now(), login: document.getElementById("u_login").value, pass: document.getElementById("u_pass").value, name: document.getElementById("u_name").value, role:'sklad', canTabel:true};
    if(id) data.users = data.users.map(x=>x.id===id?obj:x); else data.users.push(obj);
    save(); closeModal();
}

function saveEmp(id) {
    let obj = {id: id || Date.now(), name: document.getElementById("e_name").value, pos: document.getElementById("e_pos").value};
    if(id) data.employees = data.employees.map(x=>x.id===id?obj:x); else data.employees.push(obj);
    save(); closeModal();
}

function op(pid, type) {
    let p = data.products.find(x=>x.id===pid);
    let q = parseFloat(prompt("Miqdor:")); if(!q) return;
    p.qty = type==='in' ? p.qty + q : p.qty - q;
    data.transactions.push({pName:p.name, type, qty:q, uName:user.name, date:new Date().toISOString()});
    save();
}

function mark(eid, status) {
    let date = new Date().toISOString().split('T')[0];
    data.attendance = data.attendance.filter(a => !(a.empId===eid && a.date===date));
    data.attendance.push({empId:eid, date, status});
    save();
}

function closeModal() { document.getElementById("modal").classList.add("hidden"); }

function exportToExcel() {
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.products), "Ombor");
    XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data.transactions), "Tarix");
    XLSX.writeFile(wb, "Report.xlsx");
}

if(data.employees.length===0) { data.employees = [{id:101, name:"Xodim 1", pos:"Ishchi"}]; save(); }
</script>
</body>
</html>
