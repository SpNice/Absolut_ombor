<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Absolut - Ombor Tizimi</title>
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<style>
/* =========================
   GLOBAL STYLES
========================= */
:root{
 --primary1:#1e3c72;
 --primary2:#2a5298;
 --success:#27ae60;
 --warning:#f39c12;
 --danger:#e74c3c;
 --bg:#f5f5f5;
 --radius:14px;
}

*{box-sizing:border-box;font-family:Segoe UI, sans-serif;}
body{margin:0;background:var(--bg);}

header{
 background:linear-gradient(135deg,var(--primary1),var(--primary2));
 color:white;
 padding:15px;
 display:flex;
 justify-content:space-between;
 align-items:center;
 box-shadow:0 4px 12px rgba(0,0,0,.2);
}

h1{margin:0;font-size:20px;}

button{
 border:none;
 padding:10px 15px;
 border-radius:10px;
 cursor:pointer;
 color:white;
 background:linear-gradient(135deg,var(--primary1),var(--primary2));
 transition:.3s;
 margin-right: 5px;
 margin-bottom: 5px;
}
button:hover{opacity:.85}

.btn-success{background:var(--success)}
.btn-warning{background:var(--warning)}
.btn-danger{background:var(--danger)}
.btn-dark{background:#34495e}

.container{padding:15px;max-width:1200px;margin:auto;}

.card{
 background:white;
 padding:15px;
 border-radius:var(--radius);
 box-shadow:0 4px 12px rgba(0,0,0,.1);
 margin-bottom:15px;
 animation:fadeIn .3s ease;
}

@keyframes fadeIn{
 from{opacity:0;transform:translateY(10px)}
 to{opacity:1;transform:none}
}

input,select,textarea{
 width:100%;
 padding:10px;
 border-radius:8px;
 border:1px solid #ddd;
 margin-bottom:10px;
}

table{width:100%;border-collapse:collapse;font-size:14px;}
th,td{padding:10px;border-bottom:1px solid #eee;text-align:left;}
tr.low{background:#fff8e1}
tr.order{background:#ffebee}

.status-enough{color:var(--success);font-weight:bold;}
.status-low{color:var(--warning);font-weight:bold;}
.status-order{color:var(--danger);font-weight:bold;}

nav{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;}
.hidden{display:none}
footer{text-align:center;padding:10px;font-size:12px;color:#777;}

/* File upload hidden input */
#fileInput { display: none; }
</style>
</head>

<body>

<header>
 <h1>Absolut - Ombor</h1>
 <div id="userInfo"></div>
</header>

<div class="container">

<div id="loginPage" class="card">
 <h3>Tizimga kirish</h3>
 <input id="loginInput" placeholder="Login" autofocus>
 <input id="passwordInput" type="password" placeholder="Parol">
 <button onclick="login()">Kirish</button>
</div>

<div id="app" class="hidden">

 <nav>
  <button onclick="showPage('ombor')">üì¶ Ombor</button>
  <button onclick="showPage('xodimlar')">üë• Xodimlar</button>
  <button onclick="showPage('hisobot')">üìä Hisobotlar (Excel)</button>
  <button onclick="showPage('sozlamalar')">‚öôÔ∏è Sozlamalar</button>
  <button onclick="logout()" class="btn-danger">Chiqish</button>
 </nav>

 <div id="omborPage"></div>

 <div id="xodimPage" class="hidden"></div>
 
 <div id="hisobotPage" class="hidden"></div>

 <div id="sozlamalarPage" class="hidden"></div>

</div>

</div>

<footer>¬© Absolut 2026 | GitHub Host Version</footer>

<input type="file" id="fileInput" accept=".json" onchange="restoreData(this)">

<script>

/* =========================
   DATA STORAGE
========================= */
const STORAGE_KEY="absolut_local_v2";

let data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {
 products:[],
 transactions:[], // Kirim-Chiqim tarixi
 employees:[],
 users:[
  {login:"admin",password:"admin",role:"admin",fullName:"Administrator"},
  {login:"sklad",password:"123",role:"kladovshik",fullName:"Omborchi"}
 ]
};

let currentUser=null;

/* =========================
   CORE FUNCTIONS
========================= */

function save(){
 localStorage.setItem(STORAGE_KEY,JSON.stringify(data));
}

function formatNumber(n){
 return n ? n.toLocaleString("ru-RU") : "0";
}

function formatDate(isoStr){
 if(!isoStr) return "";
 return new Date(isoStr).toLocaleString("uz-UZ");
}

function notify(msg){
 alert(msg);
}

/* =========================
   AUTH
========================= */
function login(){
 const login=document.getElementById("loginInput").value;
 const pass=document.getElementById("passwordInput").value;
 const user=data.users.find(u=>u.login===login && u.password===pass);
 if(!user) return notify("Login yoki parol noto‚Äòg‚Äòri");
 
 currentUser=user;
 document.getElementById("loginPage").classList.add("hidden");
 document.getElementById("app").classList.remove("hidden");
 document.getElementById("userInfo").innerText=user.fullName;
 renderAll();
}

function logout(){
 currentUser=null;
 location.reload();
}

function showPage(p){
 ['omborPage','xodimPage','hisobotPage','sozlamalarPage'].forEach(id=>{
  document.getElementById(id).classList.add("hidden");
 });
 document.getElementById(p+"Page").classList.remove("hidden");
}

/* =========================
   OMBOR (WAREHOUSE)
========================= */
function renderOmbor(){
 const page=document.getElementById("omborPage");
 page.innerHTML="";
 
 const card=document.createElement("div");
 card.className="card";
 
 let html = `
 <h3>Mahsulotlar Ro‚Äòyxati</h3>
 <button onclick="addProduct()">+ Mahsulot Qo‚Äòshish</button>
 <table>
  <thead>
  <tr>
   <th>Nomi</th>
   <th>Qoldiq</th>
   <th>Narx</th>
   <th>Status</th>
   <th>Amallar</th>
  </tr>
  </thead>
  <tbody>
 `;

 data.products.forEach(p=>{
  const statusClass=p.status==="low"?"status-low":p.status==="order"?"status-order":"status-enough";
  const rowClass=p.status==="low"?"low":p.status==="order"?"order":"";
  
  html += `
   <tr class="${rowClass}">
    <td><b>${p.name}</b><br><small>${p.category||""}</small></td>
    <td>${formatNumber(p.quantity)} ${p.unit}</td>
    <td>${formatNumber(p.price)} so'm</td>
    <td class="${statusClass}">${getStatusLabel(p.status)}</td>
    <td>
     <button onclick="doTransaction(${p.id},'in')" class="btn-success" title="Kirim">+</button>
     <button onclick="doTransaction(${p.id},'out')" class="btn-warning" title="Chiqim">-</button>
     ${currentUser.role==='admin' ? `<button onclick="deleteProduct(${p.id})" class="btn-danger">x</button>` : ''}
    </td>
   </tr>
  `;
 });
 
 html += `</tbody></table>`;
 card.innerHTML = html;
 page.appendChild(card);
}

function getStatusLabel(s){
 if(s==="enough") return "‚úÖ Yetarli";
 if(s==="low") return "‚ö†Ô∏è Kam";
 if(s==="order") return "‚ùó Tugadi";
 return s;
}

function addProduct(){
 const name=prompt("Mahsulot nomi:");
 if(!name) return;
 const quantity=parseFloat(prompt("Boshlang‚Äòich qoldiq:",0));
 const unit=prompt("O‚Äòlchov birligi (kg, dona, litr):","dona");
 const price=parseFloat(prompt("Narxi (so‚Äòm):",0));
 const minQty=parseFloat(prompt("Minimal limit (ogohlantirish uchun):",10));
 
 data.products.push({
  id: Date.now(),
  name, quantity, unit, price, minQuantity: minQty,
  status: quantity<=minQty ? (quantity==0?"order":"low") : "enough",
  category: "Umumiy",
  createdBy: currentUser.login
 });
 save();
 renderOmbor();
}

function deleteProduct(id){
 if(!confirm("O‚Äòchirishni tasdiqlaysizmi?")) return;
 data.products = data.products.filter(p=>p.id!==id);
 save();
 renderOmbor();
}

function doTransaction(id, type){
 const p = data.products.find(x=>x.id===id);
 const qty = parseFloat(prompt(`${type==='in'?'Kirim':'Chiqim'} miqdorini kiriting:`,0));
 if(!qty || qty<=0) return;

 if(type==='in'){
  p.quantity += qty;
 } else {
  if(p.quantity < qty) return notify("Omborda buncha mahsulot yo‚Äòq!");
  p.quantity -= qty;
 }

 // Update status
 p.status = p.quantity===0 ? "order" : (p.quantity<=p.minQuantity ? "low" : "enough");

 // Log transaction
 data.transactions.push({
  id: Date.now(),
  productName: p.name,
  type: type==='in' ? "Kirim" : "Chiqim",
  quantity: qty,
  unit: p.unit,
  date: new Date().toISOString(),
  user: currentUser.login
 });

 save();
 renderOmbor();
}

/* =========================
   XODIMLAR (EMPLOYEES)
========================= */
function renderXodimlar(){
 const page=document.getElementById("xodimPage");
 page.innerHTML = `
  <div class="card">
   <h3>Xodimlar</h3>
   <button onclick="addEmployee()">+ Xodim Qo‚Äòshish</button>
   <table>
    <tr><th>Ism</th><th>Lavozim</th><th>Tel</th></tr>
    ${data.employees.map(e=>`
     <tr>
      <td>${e.name}</td>
      <td>${e.position}</td>
      <td>${e.phone}</td>
     </tr>
    `).join("")}
   </table>
  </div>
 `;
}

function addEmployee(){
 const name=prompt("Ismi:");
 const position=prompt("Lavozimi:");
 const phone=prompt("Telefon:");
 if(name) {
  data.employees.push({id:Date.now(), name, position, phone});
  save();
  renderXodimlar();
 }
}

/* =========================
   HISOBOTLAR & EXCEL (REPORTS)
========================= */
function renderHisobot(){
 const page=document.getElementById("hisobotPage");
 page.innerHTML = `
  <div class="card">
   <h3>Excel Hisobotlar</h3>
   <p>Barcha ma'lumotlarni Excel formatida yuklab olish.</p>
   <button onclick="exportToExcel()" class="btn-success">üì• Excelga Yuklash (.xlsx)</button>
  </div>
  
  <div class="card">
   <h3>Oxirgi 10 ta operatsiya</h3>
   <table>
    <tr><th>Vaqt</th><th>Mahsulot</th><th>Amal</th><th>Miqdor</th><th>Kim</th></tr>
    ${data.transactions.slice().reverse().slice(0,10).map(t=>`
     <tr>
      <td>${formatDate(t.date)}</td>
      <td>${t.productName}</td>
      <td style="color:${t.type==='Kirim'?'green':'red'}">${t.type}</td>
      <td>${formatNumber(t.quantity)} ${t.unit}</td>
      <td>${t.user}</td>
     </tr>
    `).join("")}
   </table>
  </div>
 `;
}

function exportToExcel(){
 // 1. Mahsulotlar varag'i
 const productsData = data.products.map(p => ({
  "ID": p.id,
  "Nomi": p.name,
  "Qoldiq": p.quantity,
  "Birlik": p.unit,
  "Narx": p.price,
  "Status": getStatusLabel(p.status)
 }));

 // 2. Tranzaksiyalar varag'i
 const transData = data.transactions.map(t => ({
  "Vaqt": formatDate(t.date),
  "Mahsulot": t.productName,
  "Amal": t.type,
  "Miqdor": t.quantity,
  "Xodim": t.user
 }));

 // 3. Create Workbook
 const wb = XLSX.utils.book_new();
 
 const wsProducts = XLSX.utils.json_to_sheet(productsData);
 XLSX.utils.book_append_sheet(wb, wsProducts, "Ombor Qoldiq");

 const wsTrans = XLSX.utils.json_to_sheet(transData);
 XLSX.utils.book_append_sheet(wb, wsTrans, "Kirim-Chiqim Tarixi");

 // 4. Download
 XLSX.writeFile(wb, "Absolut_Hisobot_" + new Date().toISOString().slice(0,10) + ".xlsx");
}

/* =========================
   SOZLAMALAR (SETTINGS & BACKUP)
========================= */
function renderSozlamalar(){
 const page=document.getElementById("sozlamalarPage");
 page.innerHTML = `
  <div class="card">
   <h3>Ma'lumotlar Bazasi (Backup)</h3>
   <p style="color:#777;font-size:12px">
    Diqqat! Sayt GitHub da turgani uchun ma'lumotlar faqat sizning brauzeringizda saqlanadi. 
    Boshqa qurilmaga o'tish yoki ma'lumotni yo'qotmaslik uchun tez-tez "Backup Saqlash" qiling.
   </p>
   <button onclick="backupData()" class="btn-dark">‚¨áÔ∏è Bazani Saqlash (JSON)</button>
   <button onclick="document.getElementById('fileInput').click()" class="btn-warning">‚¨ÜÔ∏è Bazani Tiklash</button>
   <br><br>
   <button onclick="clearData()" class="btn-danger">‚ö†Ô∏è Tozalash (Reset)</button>
  </div>
 `;
 
 if(currentUser.role==='admin'){
  const userDiv = document.createElement("div");
  userDiv.className="card";
  userDiv.innerHTML = `
   <h3>Foydalanuvchilar boshqaruvi</h3>
   <button onclick="addUser()">+ Foydalanuvchi Qo'shish</button>
   <ul>
    ${data.users.map(u=>`<li>${u.login} (${u.role})</li>`).join("")}
   </ul>
  `;
  page.appendChild(userDiv);
 }
}

function backupData(){
 const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
 const downloadAnchorNode = document.createElement('a');
 downloadAnchorNode.setAttribute("href", dataStr);
 downloadAnchorNode.setAttribute("download", "absolut_backup_" + new Date().toISOString().slice(0,10) + ".json");
 document.body.appendChild(downloadAnchorNode);
 downloadAnchorNode.click();
 downloadAnchorNode.remove();
}

function restoreData(input){
 const file = input.files[0];
 if(!file) return;
 const reader = new FileReader();
 reader.onload = function(e){
  try {
   const json = JSON.parse(e.target.result);
   if(json.products && json.users) {
    data = json;
    save();
    alert("Baza muvaffaqiyatli tiklandi!");
    location.reload();
   } else {
    alert("Fayl noto‚Äòg‚Äòri formatda!");
   }
  } catch(err){
   alert("Xatolik: " + err);
  }
 };
 reader.readAsText(file);
}

function clearData(){
 if(confirm("Butun tizim tozalanadi! Ishonchingiz komilmi?")){
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
 }
}

function addUser(){
 const login=prompt("Yangi login:");
 const password=prompt("Parol:");
 const role=prompt("Rol (admin/kladovshik):","kladovshik");
 if(login && password){
  data.users.push({login,password,role,fullName:login});
  save();
  renderSozlamalar();
 }
}

/* =========================
   INIT
========================= */
function renderAll(){
 renderOmbor();
 renderXodimlar();
 renderHisobot();
 renderSozlamalar();
}

// Check auth on load
if(data.users.length === 0){
 // Init default user if empty
 data.users.push({login:"admin",password:"admin",role:"admin",fullName:"Admin"});
}

</script>
</body>
</html>